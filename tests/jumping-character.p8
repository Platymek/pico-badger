pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include ../pecs/pecs.lua
#include ../pico-badger.lua

local w = pecs()
c = getComponents(w)

local s = w.entity()
s += c.new.Position(16, 16)
s += c.new.Sprite(0)

local function isSolidFunction(ent, pos, vel, col)

    for _, otherEnt in pairs(w.query({c.Position, c.Collision})) do

        if otherEnt != ent then

        local op = otherEnt[c.Position]
        local oc = otherEnt[c.Collision]

        if col:getOffset(pos.x, pos.y)
            :isIntersecting(oc:getOffset(op.x, op.y))
        then return true end

        end
    end

    return pos.y + col.y + col.h > 128
end

local function createCharacter(x, y, startVelocity)

    local e = w.entity()
    e += c.new.Position(x, y)
    e += c.new.Velocity(0, startVelocity or 0)
    e += c.new.Camera({})

    e += c.new.Collision(
        
        function(vel) 

            if vel.y != 0 then 

                e[c.Velocity].y = -e[c.Velocity].y
            end
        end, 

        -8, -8, 16, 16)

    e += c.new.Gravity(64, 64)
    e += c.new.SpriteGroup(

        Sprite:new(16,-8,-8),
        Sprite:new(17, 0,-8),
        Sprite:new(32,-8, 0),
        Sprite:new(33, 0, 0)
    )

    return e
end

local e1 = createCharacter(64, 64)
local e2 = createCharacter(64, 64 - 32, -64)

function _update60()

    w.update()
    c.PhysicsSystem(1/60, isSolidFunction)
end

function _draw()

    cls()

    line(0, 128, 128, 128, 7)

    c.GraphicsSystem()
    e1[c.Collision]:draw(nil, e1[c.Position].x, e1[c.Position].y)
    e2[c.Collision]:draw(nil, e2[c.Position].x, e2[c.Position].y)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007000000bb00000aaa00000909000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000b00b0000000a0000909000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070700000000b0000000a0000909000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000070000000b00000aaa00000999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007000000b000000000a0000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0077770000bbbb0000aaa00000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001aaaa999910000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001aaaaa999991000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01aaaaaa999999100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01aaa11a999999100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01aaa11a199199100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01aaa11a911999100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01999999aaaaaa100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01999999aaaaaa100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01999999aa1aaa100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0199991111aaaa100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00199999aaaaa1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00019999aaaa10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
